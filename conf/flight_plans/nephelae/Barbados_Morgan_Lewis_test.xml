<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">

<flight_plan alt="110.0" ground_alt="20.0" lat0="13.2676548" lon0="-59.5680089" max_dist_from_home="15000" name="Morgan Lewis" security_height="70.">
  <header>
#include "subsystems/datalink/datalink.h"
#define WaitPointFromID() { \
fp_wait_wp = 1 + (AC_ID % 3); \
fp_wait_alt = SECURITY_ALT + (float)((uint8_t)(AC_ID/3)) * 20.f; \
}
</header>
  <waypoints>
    <waypoint name="HOME" x="0" y="0"/>
    <waypoint name="STDBY" x="-34.6" y="17.4"/>
    <waypoint name="CLIMB" x="495.4" y="47.9"/>
    <waypoint name="_BASELEG" x="100.0" y="100.0"/>
    <waypoint name="_HERE" x="100." y="-100."/>
    <waypoint alt="80.0" name="AF" x="-359.6" y="29.1"/>
    <waypoint alt="30.0" name="TD" x="-149.6" y="34.8"/>
    <waypoint alt="130.0" name="W1" x="2.7" y="14.7"/>
    <waypoint alt="150.0" name="W2" x="147.5" y="14.9"/>
    <waypoint alt="170.0" name="W3" x="301.7" y="8.5"/>
    <waypoint alt="500.0" name="CLOUDBASE" x="1062.5" y="30.9"/>
    <waypoint alt="150.0" name="RETURN" x="814.6" y="30.4"/>
    <waypoint alt="30.0" name="BUNGEE" x="45.2" y="57.3"/>
    <waypoint alt="800.0" name="H1_1" x="12600.7" y="3212.4"/>
    <waypoint alt="800.0" name="H1_2" x="12868.7" y="1695.5"/>
    <waypoint alt="800.0" name="H2_1" x="11843.5" y="5848.2"/>
    <waypoint alt="800.0" name="H2_2" x="12278.4" y="4609.7"/>
    <waypoint alt="800.0" name="H3_1" x="12852.3" y="656.1"/>
    <waypoint alt="800.0" name="H3_2" x="12862.7" y="-718.9"/>
  </waypoints>
  <variables>
    <variable init="800.f" max="2500." min="100.0" step="1." type="float" var="cloud_alt"/>
    <variable init="150." max="500." min="80." step="1." type="float" var="secure_alt"/>
    <variable init="125." max="500." min="80." step="1.0" type="float" var="fp_radius"/>
    <variable init="2.0" max="4.0" min="1.0" step="0.5" type="float" var="v_climb"/>
    <variable init="-2.0" max="-1.0" min="-4.0" step="-0.5" type="float" var="v_descent"/>
    <variable init="1" max="3" min="1" step="1" type="uint8_t" var="fp_wait_wp"/>
    <!--variable init="150." max="200." min="50." step="1." type="float" var="fp_wait_alt"/-->
    <variable init="800." max="3300." min="80." step="1." type="float" var="fp_return_alt"/>
    <variable init="4200" max="4500." min="50." step="10." type="float" var="fp_max_flight_time"/>
    <variable init="1000." max="3300." min="500." step="1." type="float" var="fp_max_alt"/>
    <variable init="60." max="240." min="10." step="1." type="float" var="fp_max_lost_time"/>
    <variable init="0.5" max="1.0" min="0." step="0.1" type="float" var="fp_throttle"/>
    <variable init="0.0" max="1.0" min="-30.0" step="0.1" type="float" var="fp_pitch"/>
  </variables>
  <modules>
    <module name="mission" type="fw"/>
    <module name="nav" type="flower"/>
    <module name="nav" type="lace"/>
    <module name="nav" type="rosette"/>
    <module name="nav" type="trinity"/>
    <module name="nav" type="spiral_3D"/>
    <module name="cloud_sensor"/>
  </modules>
  <includes>
    <include name="Area" procedure="Morgan_Lewis_data.xml"/>
  </includes>
  <exceptions>
    <exception cond="(!InsideFlightZone(GetPosX(),GetPosY()) @OR (GetPosAlt() @GT fp_max_alt) @OR (GetPosAlt() @LT 50)) @AND (nav_block @GT IndexOfBlock('Standby')) @AND (nav_block @LT IndexOfBlock('land'))" deroute="Standby"/>
    <exception cond="(nav_block @GT IndexOfBlock('Standby')) @AND (nav_block @LT IndexOfBlock('land')) @AND (autopilot.flight_time + get_time_to_home()) > fp_max_flight_time" deroute="Standby"/>
    <exception cond="datalink_time > fp_max_lost_time" deroute="Standby"/>
  </exceptions>
  <blocks>
    <block name="Wait GPS">
      <set value="1" var="autopilot.kill_throttle"/>
      <while cond="!GpsFixValid()"/>
    </block>
    <block name="Geo init">
      <while cond="LessThan(NavBlockTime(), 10)"/>
    </block>
    <block name="Holding point">
      <!--all_once fun="WaitPointFromID()"/-->
      <set value="1" var="autopilot.kill_throttle"/>
      <attitude roll="0" throttle="0" vmode="throttle"/>
    </block>
    <block group="home" key="t" name="Takeoff" strip_button="Takeoff (wp CLIMB)" strip_icon="takeoff.png">
      <exception cond="GetPosAlt() > GetAltRef()+25" deroute="Standby"/>
      <set value="0" var="autopilot.kill_throttle"/>
      <set value="0" var="autopilot.flight_time"/>
      <go from="HOME" pitch="15" throttle="1.0" vmode="throttle" wp="CLIMB"/>
      <deroute block="Standby"/>
    </block>
    <block group="home" name="Bungee Take-Off" strip_button="Bungee Takeoff" strip_icon="bungee_launch.png">
      <call_once fun="nav_bungee_takeoff_setup(WP_BUNGEE)"/>
      <call fun="nav_bungee_takeoff_run()"/>
      <deroute block="Standby"/>
    </block>
    <block group="home" key="Ctrl+a" name="Standby" strip_button="Standby" strip_icon="home.png">
      <circle radius="nav_radius" wp="STDBY"/>
    </block>
    <block group="wait" name="Start wait" strip_button="Wait_start (Auto)">
      <exception cond="fp_wait_wp == 1" deroute="Wait 1"/>
      <exception cond="fp_wait_wp == 2" deroute="Wait 2"/>
      <exception cond="fp_wait_wp == 3" deroute="Wait 3"/>
      <deroute block="Standby"/>
    </block>
    <block group="wait" name="Land wait" strip_button="Wait_land (Auto)">
      <exception cond="fp_wait_wp == 1" deroute="Wait 3"/>
      <exception cond="fp_wait_wp == 2" deroute="Wait 2"/>
      <exception cond="fp_wait_wp == 3" deroute="Wait 1"/>
      <deroute block="Standby"/>
    </block>
    <block group="wait" name="Wait 1" strip_button="Wait 1">
      <!--circle alt="fp_wait_alt" radius="nav_radius" wp="W1"/-->
      <circle radius="nav_radius" wp="W1"/>
    </block>
    <block group="wait" name="Wait 2" strip_button="Wait 2">
      <!--circle alt="fp_wait_alt" radius="nav_radius" wp="W2"/-->
      <circle radius="nav_radius" wp="W2"/>
    </block>
    <block group="wait" name="Wait 3" strip_button="Wait 3">
      <!--circle alt="fp_wait_alt" radius="nav_radius" wp="W3"/-->
      <circle radius="nav_radius" wp="W3"/>
    </block>
    <block group="climb" name="Linear climb 1" strip_button="Climb 1">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <go approaching_time="60" from="_HERE" hmode="route" vmode="glide" wp="CLOUDBASE"/>
      <deroute block="Circle climb 1"/>
    </block>
    <block name="Circle climb 1">
      <circle climb="v_climb" radius="nav_radius" until="GetPosAlt() > cloud_alt-20 " vmode="climb" wp="CLOUDBASE"/>
      <deroute block="Searching cloud 1"/>
    </block>
    <block group="search" name="Searching cloud 1" strip_button="Search 1">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <set value="cloud_alt" var="WaypointAlt(WP_H1_1)"/>
      <go approaching_time="15" from="_HERE" hmode="route" wp="H1_1"/>
      <oval p1="H1_1" p2="H1_2" radius="nav_radius"/>
    </block>
    <block group="climb" name="Linear climb 2" strip_button="Climb 2">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <go approaching_time="60" from="_HERE" hmode="route" vmode="glide" wp="CLOUDBASE"/>
      <deroute block="Circle climb 2"/>
    </block>
    <block name="Circle climb 2">
      <circle climb="v_climb" radius="nav_radius" until="GetPosAlt() > cloud_alt-20 " vmode="climb" wp="CLOUDBASE"/>
      <deroute block="Searching cloud 2"/>
    </block>
    <block group="search" name="Searching cloud 2" strip_button="Search 2">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <set value="cloud_alt" var="WaypointAlt(WP_H2_1)"/>
      <go approaching_time="15" from="_HERE" hmode="route" wp="H2_1"/>
      <oval p1="H2_1" p2="H2_2" radius="nav_radius"/>
    </block>
    <block group="climb" name="Linear climb 3" strip_button="Climb 3">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <go approaching_time="60" from="_HERE" hmode="route" vmode="glide" wp="CLOUDBASE"/>
      <deroute block="Circle climb 3"/>
    </block>
    <block name="Circle climb 3">
      <circle climb="v_climb" radius="nav_radius" until="GetPosAlt() > cloud_alt-20 " vmode="climb" wp="CLOUDBASE"/>
      <deroute block="Searching cloud 3"/>
    </block>
    <block group="search" name="Searching cloud 3" strip_button="Search 3">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <set value="cloud_alt" var="WaypointAlt(WP_H3_1)"/>
      <go approaching_time="15" from="_HERE" hmode="route" wp="H3_1"/>
      <oval p1="H3_1" p2="H3_2" radius="nav_radius"/>
    </block>
    <block group="mission" name="Mission" strip_button="Mission">
      <!--exception cond="!InsideMissionZone(GetPosX(), GetPosY()) @OR (GetPosAlt() @GT 2300) @OR (GetPosAlt() @LT 70)" deroute="Land wait"/-->
      <call fun="mission_run()"/>
      <deroute block="Land wait"/>
    </block>
    <block group="mission" name="Linear descent" strip_button="Descent">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <go approaching_time="15" from="_HERE" hmode="route" vmode="glide" wp="CLOUDBASE"/>
      <deroute block="Circle descent"/>
    </block>
    <block group="mission" name="Urgent descent" strip_button="P_Down">
      <set value="0." var="fp_throttle"/>
      <set value="-5." var="fp_pitch"/>
      <set value="secure_alt" var="flight_altitude"/>
      <circle pitch="fp_pitch" radius="nav_radius" throttle="fp_throttle" until="secure_alt > GetPosAlt()" vmode="throttle" wp="RETURN"/>
    </block>
    <block name="Circle descent">
      <circle climb="v_descent" radius="nav_radius" until="secure_alt > GetPosAlt()" vmode="climb" wp="CLOUDBASE"/>
      <deroute block="Land wait"/>
    </block>
    <block group="mission" name="Return" strip_button="Return">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <go alt="fp_return_alt" approaching_time="15" from="_HERE" hmode="route" wp="RETURN"/>
      <deroute block="Land wait"/>
    </block>
    <block group="land" name="Land Right AF-TD" strip_button="Land right (wp AF-TD)" strip_icon="land-right.png">
      <set value="DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <deroute block="land"/>
    </block>
    <block group="land" name="Land Left AF-TD" strip_button="Land left (wp AF-TD)" strip_icon="land-left.png">
      <set value="-DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <deroute block="land"/>
    </block>
    <block name="land">
      <call_once fun="nav_compute_baseleg(WP_AF, WP_TD, WP__BASELEG, nav_radius)"/>
      <circle radius="nav_radius" until="NavCircleCount() > 0.5" wp="_BASELEG"/>
      <circle radius="nav_radius" until="And(NavQdrCloseTo(DegOfRad(baseleg_out_qdr)-(nav_radius/fabs(nav_radius))*10), 10 > fabs(GetPosAlt() - WaypointAlt(WP__BASELEG)))" wp="_BASELEG"/>
    </block>
    <block name="final">
      <exception cond="GetAltRef() + 6 > GetPosAlt()" deroute="flare"/>
      <go from="AF" hmode="route" vmode="glide" wp="TD"/>
    </block>
    <block name="flare">
      <go exceeding_time="30" from="AF" hmode="route" throttle="0.0" vmode="throttle" wp="TD"/>
      <attitude roll="0.0" throttle="0.0" until="FALSE" vmode="throttle"/>
    </block>
  </blocks>
</flight_plan>

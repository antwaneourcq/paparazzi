<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">

<flight_plan alt="100.0" ground_alt="20.0" lat0="13.2676548" lon0="-59.5680089" max_dist_from_home="9800" name="Morgan Lewis" security_height="70.">
  <header>
#include "subsystems/datalink/datalink.h"

#define WaitPointFromID() { \
fp_wait_wp = 1 + (AC_ID % 3); \
fp_wait_alt = SECURITY_ALT + (float)((uint8_t)(AC_ID/3)) * 20.f; \
}
  </header>
  <waypoints>
    <waypoint name="HOME" x="0" y="0"/>
    <waypoint name="STDBY" x="-55.7" y="69.5"/>
    <waypoint name="CLIMB" x="351.4" y="67.6"/>
    <waypoint name="_BASELEG" x="100.0" y="100.0"/>
    <waypoint name="_HERE" x="100." y="-100."/>
    <waypoint alt="80.0" name="AF" x="-340.7" y="34.0"/>
    <waypoint alt="30.0" name="TD" x="-163.2" y="34.4"/>
    <waypoint alt="30.0" name="BUNGEE" x="45.2" y="57.3"/>
    <waypoint alt="150.0" name="W1" x="383.4" y="-301.1"/>
    <waypoint alt="150.0" name="W2" x="406.7" y="-100.4"/>
    <waypoint alt="150.0" name="W3" x="199.8" y="-4.2"/>
    <waypoint alt="800.0" name="CLOUDBASE" x="2370.3" y="579.8"/>
    <waypoint alt="150.0" name="RETURN" x="647.6" y="371.9"/>
    <waypoint alt="800.0" name="H1_1" x="7814.3" y="1969.2"/>
    <waypoint alt="800.0" name="H1_2" x="7985.7" y="945.5"/>
    <waypoint alt="800.0" name="H2_1" x="7394.6" y="3380.4"/>
    <waypoint alt="800.0" name="H2_2" x="7761.9" y="2421.5"/>
    <waypoint alt="800.0" name="H3_1" x="8251.7" y="540.3"/>
    <waypoint alt="800.0" name="H3_2" x="8398.5" y="-517.1"/>
  </waypoints>
  <variables>
    <variable init="800.f" max="2500." min="100.0" step="1." type="float" var="cloud_alt"/>
    <variable init="150." max="250." min="80." step="1." type="float" var="secure_alt"/>
    <variable init="100." max="500." min="80." step="1.0" type="float" var="fp_radius"/>
    <variable init="2.0" max="4.0" min="1.0" step="0.5" type="float" var="v_climb"/>
    <variable init="-2.0" max="-1.0" min="-4.0" step="-0.5" type="float" var="v_descent"/>
    <variable init="1" max="3" min="1" step="1" type="uint8_t" var="fp_wait_wp"/>
    <variable init="70." max="200." min="50." step="1." type="float" var="fp_wait_alt"/>
    <variable init="4200" max="4500." min="50." step="10." type="float" var="fp_max_flight_time"/>
    <variable init="1000." max="3300." min="500." step="1." type="float" var="fp_max_alt"/>
  </variables>
  <modules>
    <module name="mission" type="fw"/>
    <module name="nav" type="flower"/>
    <module name="nav" type="lace"/>
    <module name="nav" type="rosette"/>
    <module name="nav" type="trinity"/>
    <module name="nav" type="spiral_3D"/>
    <module name="cloud_sensor"/>
  </modules>
  <includes>
    <include name="Area" procedure="Morgan_Lewis_data.xml"/>
  </includes>
  <exceptions>
    <exception cond="(!InsideFlightZone(GetPosX(),GetPosY()) @OR (GetPosAlt() @GT fp_max_alt) @OR (GetPosAlt() @LT 50)) @AND (nav_block @GT IndexOfBlock('Standby')) @AND (nav_block @LT IndexOfBlock('land'))" deroute="Standby"/>
    <exception cond="(nav_block @GT IndexOfBlock('Standby')) @AND (nav_block @LT IndexOfBlock('land')) @AND (autopilot.flight_time + get_time_to_home()) > fp_max_flight_time" deroute="Standby"/>
    <!--exception cond="datalink_time > 20" deroute="Standby"/-->
  </exceptions>
  <blocks>
    <block name="Wait GPS">
      <set value="1" var="autopilot.kill_throttle"/>
      <while cond="!GpsFixValid()"/>
    </block>
    <block name="Geo init">
      <while cond="LessThan(NavBlockTime(), 10)"/>
    </block>
    <block name="Holding point">
      <call_once fun="WaitPointFromID()"/>
      <set value="1" var="autopilot.kill_throttle"/>
      <attitude roll="0" throttle="0" vmode="throttle"/>
    </block>
    <block group="home" key="t" name="Takeoff" strip_button="Takeoff (wp CLIMB)" strip_icon="takeoff.png">
      <exception cond="GetPosAlt() > GetAltRef()+25" deroute="Standby"/>
      <set value="0" var="autopilot.kill_throttle"/>
      <set value="0" var="autopilot.flight_time"/>
      <go from="HOME" pitch="15" throttle="1.0" vmode="throttle" wp="CLIMB"/>
      <deroute block="Standby"/>
    </block>
    <block group="home" name="Bungee Take-Off" strip_button="Bungee Takeoff" strip_icon="bungee_launch.png">
      <call_once fun="nav_bungee_takeoff_setup(WP_BUNGEE)"/>
      <call fun="nav_bungee_takeoff_run()"/>
      <deroute block="Standby"/>
    </block>
    <block group="home" key="Ctrl+a" name="Standby" strip_button="Standby" strip_icon="home.png">
      <circle radius="nav_radius" wp="STDBY"/>
    </block>
    <block group="wait" name="Auto wait" strip_button="Wait (Auto)">
      <exception cond="fp_wait_wp == 1" deroute="Wait 1"/>
      <exception cond="fp_wait_wp == 2" deroute="Wait 2"/>
      <exception cond="fp_wait_wp == 3" deroute="Wait 3"/>
      <deroute block="Standby"/>
    </block>
    <block group="wait" name="Wait 1" strip_button="Wait 1">
      <circle alt="fp_wait_alt" radius="nav_radius" wp="W1"/>
    </block>
    <block group="wait" name="Wait 2" strip_button="Wait 2">
      <circle alt="fp_wait_alt" radius="nav_radius" wp="W2"/>
    </block>
    <block group="wait" name="Wait 3" strip_button="Wait 3">
      <circle alt="fp_wait_alt" radius="nav_radius" wp="W3"/>
    </block>
    <block group="climb" name="Linear climb 1" strip_button="Climb 1">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <go from="_HERE" hmode="route" vmode="glide" wp="CLOUDBASE" approaching_time="60"/>
      <deroute block="Circle climb 1"/>
    </block>
    <block name="Circle climb 1">
      <circle climb="v_climb" radius="nav_radius" until="GetPosAlt() > cloud_alt-20 " vmode="climb" wp="CLOUDBASE"/>
      <deroute block="Searching cloud 1"/>
    </block>
    <block group="search" name="Searching cloud 1" strip_button="Search 1">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <go from="_HERE" wp="H1_1" hmode="route" approaching_time="15"/>
      <oval p1="H1_1" p2="H1_2" radius="nav_radius"/>
    </block>
    <block group="climb" name="Linear climb 2" strip_button="Climb 2">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <go from="_HERE" hmode="route" vmode="glide" wp="CLOUDBASE" approaching_time="60"/>
      <deroute block="Circle climb 2"/>
    </block>
    <block name="Circle climb 2">
      <circle climb="v_climb" radius="nav_radius" until="GetPosAlt() > cloud_alt-20 " vmode="climb" wp="CLOUDBASE"/>
      <deroute block="Searching cloud 2"/>
    </block>
    <block group="search" name="Searching cloud 2" strip_button="Search 2">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <go from="_HERE" wp="H2_1" hmode="route" approaching_time="15"/>
      <oval p1="H2_1" p2="H2_2" radius="nav_radius"/>
    </block>
    <block group="climb" name="Linear climb 3" strip_button="Climb 3">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <go from="_HERE" hmode="route" vmode="glide" wp="CLOUDBASE" approaching_time="60"/>
      <deroute block="Circle climb 3"/>
    </block>
    <block name="Circle climb 3">
      <circle climb="v_climb" radius="nav_radius" until="GetPosAlt() > cloud_alt-20 " vmode="climb" wp="CLOUDBASE"/>
      <deroute block="Searching cloud 3"/>
    </block>
    <block group="search" name="Searching cloud 3" strip_button="Search 3">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <go from="_HERE" wp="H3_1" hmode="route" approaching_time="15"/>
      <oval p1="H3_1" p2="H3_2" radius="nav_radius"/>
    </block>
    <block group="mission" name="Mission" strip_button="Mission">
      <exception cond="!InsideMissionZone(GetPosX(), GetPosY()) @OR (GetPosAlt() @GT 2300) @OR (GetPosAlt() @LT 70)" deroute="Auto wait"/>
      <call fun="mission_run()"/>
      <deroute block="Auto wait"/>
    </block>
    <block group="mission" name="Linear descent" strip_button="Descent">
      <call_once fun="NavSetWaypointPosAndAltHere(WP__HERE)"/>
      <go from="_HERE" hmode="route" vmode="glide" wp="CLOUDBASE" approaching_time="15"/>
      <deroute block="Circle descent"/>
    </block>
    <block name="Circle descent">
      <circle climb="v_descent" radius="nav_radius" until="secure_alt > GetPosAlt()" vmode="climb" wp="CLOUDBASE"/>
      <deroute block="Auto wait"/>
    </block>
    <block group="land" name="Land Right AF-TD" strip_button="Land right (wp AF-TD)" strip_icon="land-right.png">
      <set value="DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <deroute block="land"/>
    </block>
    <block group="land" name="Land Left AF-TD" strip_button="Land left (wp AF-TD)" strip_icon="land-left.png">
      <set value="-DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <deroute block="land"/>
    </block>
    <block name="land">
      <call_once fun="nav_compute_baseleg(WP_AF, WP_TD, WP__BASELEG, nav_radius)"/>
      <circle radius="nav_radius" until="NavCircleCount() > 0.5" wp="_BASELEG"/>
      <circle radius="nav_radius" until="And(NavQdrCloseTo(DegOfRad(baseleg_out_qdr)-(nav_radius/fabs(nav_radius))*10), 10 > fabs(GetPosAlt() - WaypointAlt(WP__BASELEG)))" wp="_BASELEG"/>
    </block>
    <block name="final">
      <exception cond="GetAltRef() + 6 > GetPosAlt()" deroute="flare"/>
      <!--go from="AF" hmode="route" vmode="glide" wp="TD"/-->
      <go from="AF" hmode="route" vmode="alt" wp="TD"/>
    </block>
    <block name="flare">
      <go exceeding_time="30" from="AF" hmode="route" throttle="0.0" vmode="throttle" wp="TD"/>
      <attitude roll="0.0" throttle="0.0" until="FALSE" vmode="throttle"/>
    </block>
  </blocks>
</flight_plan>
